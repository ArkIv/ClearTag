var port=chrome.runtime.connect({name:"popupConnectFlag"});port.postMessage({event:"OpenAndConnect"});var bgPage=chrome.extension.getBackgroundPage(),CurrentSelectUrl="";function getCurrentTabUrl(callback){var queryInfo={active:!0,currentWindow:!0};chrome.tabs.query(queryInfo,tabs=>{var tab,url=tabs[0].url;console.assert("string"==typeof url,"tab.url should be a string"),callback(url)})}function startClearClassId(){var selectUrl=document.querySelector(".selectUrl"),selectClass=document.querySelector(".selectClass"),selectNoScript=document.querySelector(".selectNoScript"),tabHeader_1_4=document.getElementById("tabHeader_1_4"),tab1=document.getElementById("tab-1"),tab2=document.getElementById("tab-2");tab2.style.visibility="hidden";var tab3=document.getElementById("tab-3");tab3.style.visibility="hidden";let textOptionUrl=document.querySelector(".textOptionUrl"),textOptionClass=document.querySelector(".textOptionClass"),textOptionNoScript=document.querySelector(".textOptionNoScript"),addrCurrentTooltip=document.querySelector(".addrCurrentTooltip"),addrCurrentSpan=document.querySelector(".addrCurrentSpan"),keys=Object.keys(bgPage.selectors);Log("Прочитали селекторы:","info",keys),selectUrl.innerHTML="";for(let i=0;i<keys.length;i++){let opt=document.createElement("option");opt.innerHTML=keys[i],selectUrl.appendChild(opt),sortetSelect(selectUrl,!0)}var jsTriggers,jsTriggers3;document.querySelectorAll(".js-tab-trigger").forEach(function(trigger){trigger.addEventListener("click",function(){var id=this.getAttribute("data-tab"),content=document.querySelector('.js-tab-content[data-tab="'+id+'"]'),activeTrigger=document.querySelector(".js-tab-trigger.active"),activeContent=document.querySelector(".js-tab-content.active");activeTrigger.classList.remove("active"),trigger.classList.add("active"),activeContent.classList.remove("active"),content.classList.add("active")})}),document.querySelectorAll(".js-tab-trigger3").forEach(function(trigger){trigger.addEventListener("click",function(){var id=this.getAttribute("data-tab"),content=document.querySelector('.js-tab-content3[data-tab="'+id+'"]'),activeTrigger=document.querySelector(".js-tab-trigger3.active"),activeContent=document.querySelector(".js-tab-content3.active");activeTrigger.classList.remove("active"),trigger.classList.add("active"),activeContent.classList.remove("active"),content.classList.add("active")})});var nabclick=document.querySelector(".js-tab-trigger[data-tab='4']"),event=new Event("click");nabclick.dispatchEvent(event);var nabclick=document.querySelector(".js-tab-trigger3[data-tab='1']"),event=new Event("click");nabclick.dispatchEvent(event);var buttonInsertUrl=document.querySelector(".buttonInsertUrl"),buttonInsertClass=document.querySelector(".buttonInsertClass");let buttonInsertNoScript=document.querySelector(".buttonInsertNoScript");function removeOptionUrl(e){if("option"==e.target.nodeName.toLowerCase()){if("!_____all_url_____!"==(CurrentSelectUrl=selectUrl.options[selectUrl.selectedIndex].value.trim()))return selectUrl.style.backgroundColor="yellow",void setTimeout(function(){selectUrl.style.backgroundColor="white"},50);delete bgPage.selectors[CurrentSelectUrl],CurrentSelectUrl="",addrCurrentTooltip.innerHTML="",addrCurrentSpan.innerHTML="",textOptionUrl.value=e.target.value,e.target.remove(),isSelectedTab2()}}function removeOptionClass(e){"option"==e.target.nodeName.toLowerCase()&&(textOptionClass.value=e.target.value,e.target.remove(),saveSelectors())}function removeOptionNoScript(e){"option"==e.target.nodeName.toLowerCase()&&(textOptionNoScript.value=e.target.value,e.target.remove(),saveSelectors())}function isSelectedTab2(Key){if(""==CurrentSelectUrl)tab2.style.visibility="hidden",tab3.style.visibility="hidden";else if(tab2.style.visibility="visible",tab3.style.visibility="visible",tab2.innerHTML="Селекторы (0)",tab3.innerHTML="No scripts (0)",selectClass.innerHTML="",selectNoScript.innerHTML="",Key){bgPage.selectors[Key]||(bgPage.selectors[Key]={elements:"",noscripts:""});let str=bgPage.selectors[Key].elements;if(str){let arr=str.split(",");for(let i=0;i<arr.length;i++)addSelectClass(!1,arr[i]),tab2.innerHTML="Селекторы ("+(i+1)+")";Log("elements:","info",str)}let str2=bgPage.selectors[Key].noscripts;if(str2){let arr=str2.split(",");for(let i=0;i<arr.length;i++)addSelectNoScript(!1,arr[i]),tab3.innerHTML="No scripts ("+(i+1)+")";Log("noscripts:","info",str2)}}}function addSelectUrl(txt){txt=decodeURIComponent(txt).toLowerCase().trim();let res=isOptionText(selectUrl,txt);if(0==res){let opt=document.createElement("option");opt.innerHTML=txt,selectUrl.appendChild(opt),sortetSelect(selectUrl,!0),selectUrl.selectedIndex=opt.index,selectUrl.focus(),CurrentSelectUrl=selectUrl.options[selectUrl.selectedIndex].value.trim()}else CurrentSelectUrl=res.value.trim();addrCurrentTooltip.innerHTML=CurrentSelectUrl,addrCurrentSpan.innerHTML=CurrentSelectUrl,isSelectedTab2(CurrentSelectUrl)}function addSelectNoScript(focus,txt){let res;if(txt=txt||textOptionNoScript.value,txt=decodeURIComponent(txt).toLowerCase().trim(),0==isOptionText(selectNoScript,txt)){let opt=document.createElement("option");opt.innerHTML=txt,selectNoScript.appendChild(opt),sortetSelect(selectNoScript,!0),1==focus&&(selectNoScript.selectedIndex=opt.index,selectNoScript.focus())}}function addSelectClass(focus,txt){let res;if(txt=(txt=txt||textOptionClass.value).trim(),0==isOptionText(selectClass,txt)){let opt=document.createElement("option");"."==txt[0]?opt.classList.add("optionClass"):"#"==txt[0]?opt.classList.add("optionId"):opt.classList.add("optionTag"),opt.innerHTML=txt,selectClass.appendChild(opt),sortetSelect(selectClass),1==focus&&(selectClass.selectedIndex=opt.index,selectClass.focus())}}function sortetSelect(obj){for(nodes=obj.getElementsByTagName("OPTION"),len=nodes.length,sorted=[];nodes[0];)sorted.push(new String(nodes[0].value)),sorted[sorted.length-1].element=nodes[0],obj.removeChild(nodes[0]);sorted=sorted.sort();for(var i=0;i<len;i++)obj.appendChild(sorted[i].element)}function isOptionText(obj,txt){var i;if(0==obj.options.length)return!1;for(i=0;i<obj.options.length;i++){regex=(regex=(regex=obj.options[i].text.toLowerCase()).replace(new RegExp(/[[\^$.|?+()\/]/g),"\\$&")).replace(/\*/gi,"[\\W\\w]*")+"$";var regex=new RegExp(regex);if(regex.test(txt.trim()))return obj.selectedIndex=obj.options[i].index,obj.focus(),obj.style.backgroundColor="yellow",setTimeout(function(){obj.style.backgroundColor="white"},50),obj.options[i]}return!1}function getListString(List){var myList=List.value.split("\n"),ListBuf="",index,len;for(index=0,len=myList.length;index<len;++index)""!=myList[index].trim()&&(ListBuf.length>0?ListBuf+=","+myList[index].trim():ListBuf+=myList[index].trim());return ListBuf}function closePopup(){var bgPage;chrome.extension.getBackgroundPage().delListener(),window.close()}function Log(message,color,obj){var bgPage;chrome.extension.getBackgroundPage().Log("[popup] "+message,color,obj),console.log("[popup] "+message,obj)}function saveSelectors(){""!=CurrentSelectUrl&&(bgPage.selectors[CurrentSelectUrl].elements=selectToStr(selectClass),bgPage.selectors[CurrentSelectUrl].noscripts=selectToStr(selectNoScript),Log("Запись 1:","info",bgPage.selectors))}function selectToStr(Select){let selectStr="";for(let i=0;i<Select.options.length;i++)selectStr+=0==i?Select.options[i].text:","+Select.options[i].text;return selectStr}buttonInsertUrl.addEventListener("click",()=>{textOptionUrl.value=textOptionUrl.value.trim(),""!=textOptionUrl.value&&addSelectUrl(textOptionUrl.value)}),buttonInsertClass.addEventListener("click",()=>{textOptionClass.value=textOptionClass.value.trim(),""!=textOptionClass.value&&(addSelectClass(!0),saveSelectors())}),buttonInsertNoScript.addEventListener("click",()=>{textOptionNoScript.value=textOptionNoScript.value.trim(),""!=textOptionNoScript.value&&(addSelectNoScript(!0),saveSelectors())}),tabHeader_1_4.addEventListener("click",()=>{}),selectUrl.addEventListener("dblclick",removeOptionUrl),selectClass.addEventListener("dblclick",removeOptionClass),selectNoScript.addEventListener("dblclick",removeOptionNoScript),selectUrl.addEventListener("change",()=>{CurrentSelectUrl=selectUrl.options[selectUrl.selectedIndex].value.trim(),addrCurrentTooltip.innerHTML=CurrentSelectUrl,addrCurrentSpan.innerHTML=CurrentSelectUrl,isSelectedTab2(CurrentSelectUrl)}),chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){if(tabs[0]){let url=tabs[0].url.toLowerCase().trim(),idx=url.indexOf("&");idx>=0&&(url=url.substr(0,idx)+"*"),textOptionUrl.value=url}}),sortetSelect(selectUrl),String.prototype.byteLength=function(){for(var str=this,length=str.length,count=0,i=0,ch=0;i<length;i++)(ch=str.charCodeAt(i))<=127?count++:count+=ch<=2047?2:ch<=65535?3:ch<=2097151?4:ch<=67108863?5:6;return count}}chrome.browserAction.setBadgeText({text:"Ура!"}),document.addEventListener("DOMContentLoaded",()=>{var inf;startClearClassId(),document.getElementsByClassName("textInfo")[0].innerHTML=textInfo});