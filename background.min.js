var logEnabled=!0,allFrames=!1,selectors={};function readBase(){localforage.getItem("ClearClassId_Lists").then(function(value){value?(selectors=value,console.log("Прочитано из базы",value)):createBase()}).catch(function(err){console.log("При чтениииз базы",err)})}function createBase(){selectors["!_____all_url_____!"]=".content__adv-footer,.globalClass_ET",localforage.setItem("ClearClassId_Lists",selectors).then(function(value){Log("Создана база","info",value)}).catch(function(err){Log("Ошибка создания базы","error",err)})}let test=!1;function updateTab(tabId,changeInfo,tab){let timer=setTimeout(tab=>{"complete"==changeInfo.status&&(Log("Загрузили.....","info",tab.url),checkUrl2(tab.url,tabId),test=!0,clearTimeout(timer))},1e3,tab)}function checkUrl2(url,tabId){if(selectors)for(var k in selectors){regex=(regex=(regex=k+="").replace(new RegExp(/[[\^$.|?+()\/]/g),"\\$&")).replace(/\*/gi,"[\\W\\w]*")+"$";var regex=new RegExp(regex);regex.test(url.trim())&&setTimeout((regex,url,tabId)=>{Log("url:","error",url,tabId),Log("regex:","error",regex.toString(),tabId),Log("селекторы","error",selectors[k],tabId),arrayPorts[tabId]&&(arrayPorts[tabId].postMessage({setClassList:selectors[k]}),arrayPorts[tabId].postMessage({func:"removeElement"}))},1e3,regex,url,tabId)}}chrome.tabs.onUpdated.addListener(updateTab),chrome.webRequest.onBeforeRequest.addListener(function(details){return{cancel:!0}},{urls:["https://yandex.ru/clck/click/*","https://mc.yandex.ru/clmap/*","https://files.cointraffic.io/js/pnd/script.js","https://mc.yandex.ru/watch/*","http://api.solvemedia.com/papi/_puzzle.js","http://mell,owads.com/js/*"]},["blocking"]),chrome.webRequest.onCompleted.addListener(function(Details){},{urls:["http://*/*","https://*/*"]},["responseHeaders"]);var tik=[];function checkUrl(Details){console.log(Details),chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){if(tabs[0]){var currentUrl=tabs[0].url.toLowerCase();test?(tik.push(Details.url),timerWait(currentUrl,tabs[0].id)):console.log("tik: "+currentUrl)}})}let timerWaitId=null,portPopup;function timerWait(currentUrl,tabId){clearTimeout(timerWaitId),timerWaitId=setTimeout(function(){let t=[];t[0]=tik,Log("Загрузка:","info",t,tabId),tik=[],t=[]},1e3,tabId,currentUrl)}function startBackground(){localforage.getItem("ClearClassId_Lists").then(function(value){Log("Загрузили из базы:","info",value),startBackground2()}).catch(function(err){console.log(err)})}function startBackground2(){getList("maskList",savedList=>{var urlList="";if(savedList){var arr=savedList.split(",");Log("Загрузили адреса прослушки:","info",arr);var urlfind="<all_urls>";savedList&&(urlfind=arr),"urlfind"==savedList&&(urlfind="<all_urls>"),chrome.webRequest.onCompleted.addListener(urlListener,{urls:urlfind},["responseHeaders"]),urlListener()}})}function getList(key,callback){chrome.storage.sync.get(key,items=>{callback(items[key])})}function loadListClasses(key,callback){chrome.storage.sync.get(key,items=>{callback(items[key])})}function urlListener(details){chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){if(tabs[0]){var currenttab=tabs[0].url;details&&details.url!=currenttab||loadListClasses("classList",savedList=>{var classBuffer='var ClearClassBuffer = "'+savedList+'";';loadListClasses("idList",savedList=>{var idBuffer='var ClearIdBuffer = "'+savedList+'";';uploadElement(tabs[0],classBuffer+idBuffer)})})}})}function uploadElement(Tab,savedList){setTimeout(function(){chrome.tabs.executeScript(Tab.id,{code:savedList,allFrames:allFrames},()=>{chrome.runtime.lastError?Log("не загрузить списки","error",chrome.runtime.lastError):(Log("Списки загружены-3","success","инициатор: "+Tab.url),uploadScript(Tab))})},5e3)}function uploadScript(Tab){chrome.tabs.executeScript(Tab.id,{file:"deletetimer.js",allFrames:allFrames},()=>{chrome.runtime.lastError?Log('error: не загрузился скрипт "deletetimer"',"error",chrome.runtime.lastError):Log('скрипт "deletetimer" загружен',"success")})}function catchLastError(){chrome.runtime.lastError?Log("error: ","error",chrome.runtime.lastError):Log("отключить это","success")}function delListener(){chrome.webRequest.onCompleted.removeListener(urlListener),startBackground()}chrome.webRequest.onCompleted.addListener(function(details){console.log(details),chrome.tabs.executeScript(details.tabId,{file:"deleteclasses.js",allFrames:allFrames},()=>{chrome.runtime.lastError?Log('error: не загрузился скрипт "deleteclasses"',"error",chrome.runtime.lastError):(Log('скрипт "deleteclasses" загружен',"success"),Log("url (на что среагировал):"+details.url,"success"))})},{urls:["*://tv.yandex.ru/*date*"]},["responseHeaders"]),document.addEventListener("DOMContentLoaded",()=>{Log("есть DOMContentLoaded","info","test"),readBase(),startBackground()});let arrayPorts={};function disPort(extPort){Log("Поорт таб disconnect: ","info",extPort.sender.tab.id),arrayPorts[extPort.sender.tab.id]&&delete arrayPorts[extPort.sender.tab.id],Log("Порты делете","info",arrayPorts)}function disconnectPort(port){"popupConnectFlag"==port.name&&(Log("Отключились от Popup.js  окно закрылось.","info"),localforage.setItem("ClearClassId_Lists",selectors).then(function(value){Log("Сохранено в базу при закрытии","info",port),console.log("Sender:","info",port)}).catch(function(err){Log("Ошибка записи в базу","error",err)}))}function Log(message,color,obj,tabId){if(0!=logEnabled){switch(color=color||"black"){case"success":case"ok":color="Green";break;case"info":color="DodgerBlue";break;case"error":case"err":color="Red";break;case"warning":color="Orange";break;default:color=color}if(obj){var objmess=JSON.stringify(obj);console.log("%cClearClassId : %c[Bg]:"+message,"color: blue;font-weight: bold","color:"+color,obj),chrome.tabs.executeScript(tabId,{code:"console.log('%cClearClassId : %c[Bg]:"+message+"','color: blue;font-weight: bold', 'color: "+color+"',"+objmess+");",allFrames:allFrames},catchLastErrorLog)}else console.log("%cClearClassId : %c[Bg]:"+message,"color: blue;font-weight: bold","color:"+color),chrome.tabs.executeScript(tabId,{code:"console.log('%cClearClassId : %c[Bg]:"+message+"','color: blue;font-weight: bold','color: "+color+"');",allFrames:allFrames},catchLastErrorLog)}}function catchLastErrorLog(){if(chrome.runtime.lastError){var obj=chrome.runtime.lastError,err=obj.messsage;console.log("%cClearClassId : %cError:","color: blue;font-weight: bold","color: red",obj)}}chrome.runtime.onConnect.addListener(function(extPort){extPort.onMessage.addListener(function(msg,port){"popupConnectFlag"==port.name?"OpenAndConnect"==msg.event&&(portPopup=port,port.onDisconnect.addListener(disconnectPort),Log("Есть связь с popup.js...","info"),console.log("Открыт popup",msg,port)):"Content Script"==port.name&&"newTab"==msg.msg&&(port&&port.sender&&port.sender.tab&&port.sender.tab.id&&(port.onDisconnect.addListener(disPort),arrayPorts[port.sender.tab.id]=port,Log("Поорт таб","info",port.sender.tab.id)),Log("Порты","info",arrayPorts))}),Log("что то прилетело в back ","info",extPort)});